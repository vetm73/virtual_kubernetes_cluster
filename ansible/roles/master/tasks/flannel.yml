- sysctl: name=net.bridge.bridge-nf-call-ip6tables value=1 state=present reload=yes sysctl_set=yes
- sysctl: name=net.bridge.bridge-nf-call-iptables value=1 state=present reload=yes sysctl_set=yes
- name: install flannel
  shell: >
    export KUBECONFIG=/etc/kubernetes/admin.conf ;
    kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
- shell: >
    export KUBECONFIG=/etc/kubernetes/admin.conf ;
    kubectl -n kube-system get pods --field-selector metadata.name=$( kubectl get pods -n kube-system | awk '/flannel/ {print $1;exit}' )
  register: result
  until: result.stdout.find("Running") != -1
  retries: 100
  delay: 10
